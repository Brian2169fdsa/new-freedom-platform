rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // Helper Functions
    // ========================================================================

    /// Returns true if the request is from an authenticated user.
    function isAuthenticated() {
      return request.auth != null;
    }

    /// Returns true if the authenticated user's UID matches the given userId.
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /// Returns true if the authenticated user has the given custom-claim role.
    function hasRole(role) {
      return isAuthenticated() && request.auth.token.role == role;
    }

    /// Returns true if the user is an admin or super_admin.
    function isAdmin() {
      return isAuthenticated()
        && request.auth.token.role in ['admin', 'super_admin'];
    }

    /// Returns true if the user is a case_manager.
    function isCaseManager() {
      return hasRole('case_manager');
    }

    /// Returns true if the user is admin, super_admin, or case_manager.
    function isStaff() {
      return isAdmin() || isCaseManager();
    }

    /// Returns true if the authenticated user's UID is in the participants list.
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }

    /// Returns true if the case manager is assigned to the given user.
    /// Looks up the user doc to check reentry.caseManagerId.
    function isAssignedCaseManager(userId) {
      return isCaseManager()
        && get(/databases/$(database)/documents/users/$(userId)).data.reentry.caseManagerId == request.auth.uid;
    }

    /// Validates that a required string field is non-empty.
    function isNonEmptyString(value) {
      return value is string && value.size() > 0;
    }

    /// Validates that a timestamp field is present.
    function isValidTimestamp(value) {
      return value is timestamp;
    }

    // ========================================================================
    // 1. Users
    //    - Users can read/update their own document
    //    - Admins can read/write all user documents
    //    - Staff (case managers) can read user documents
    // ========================================================================
    match /users/{userId} {
      allow read: if isOwner(userId) || isStaff();

      allow create: if isOwner(userId)
        && request.resource.data.uid == userId
        && isNonEmptyString(request.resource.data.displayName)
        && isNonEmptyString(request.resource.data.email);

      allow update: if isOwner(userId) || isAdmin();

      allow delete: if isAdmin();
    }

    // ========================================================================
    // 2. Posts (Lane 3 - My Struggle social feed)
    //    - All authenticated users can read approved posts
    //    - Authenticated users can create posts
    //    - Authors can update their own posts
    //    - Admins can update/delete any post
    //    - Staff can update (for moderation)
    // ========================================================================
    match /posts/{postId} {
      allow read: if isAuthenticated()
        && (resource.data.moderationStatus == 'approved'
            || resource.data.authorId == request.auth.uid
            || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.authorId == request.auth.uid
        && isNonEmptyString(request.resource.data.content)
        && request.resource.data.moderationStatus == 'pending';

      allow update: if isAuthenticated()
        && (resource.data.authorId == request.auth.uid || isStaff())
        // Authors cannot change their own moderation status
        && (resource.data.authorId != request.auth.uid
            || request.resource.data.moderationStatus == resource.data.moderationStatus
            || isStaff());

      allow delete: if isAuthenticated()
        && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // ========================================================================
    // 3. Comments
    //    - Authenticated users can create comments
    //    - Authors can update/delete their own comments
    //    - Admins can manage all comments
    //    - Staff can update (for moderation)
    // ========================================================================
    match /comments/{commentId} {
      allow read: if isAuthenticated()
        && (resource.data.moderationStatus == 'approved'
            || resource.data.authorId == request.auth.uid
            || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.authorId == request.auth.uid
        && isNonEmptyString(request.resource.data.content)
        && request.resource.data.moderationStatus == 'pending';

      allow update: if isAuthenticated()
        && (resource.data.authorId == request.auth.uid || isStaff());

      allow delete: if isAuthenticated()
        && (resource.data.authorId == request.auth.uid || isAdmin());
    }

    // ========================================================================
    // 4. Messages
    //    - Only participants (senderId/recipientId) can read/write
    //    - Sender must be the authenticated user on create
    //    - Admins can read all messages
    // ========================================================================
    match /messages/{messageId} {
      allow read: if isAuthenticated()
        && (resource.data.senderId == request.auth.uid
            || request.auth.uid in resource.data.readBy
            // Check conversation participants for group messages
            || isAdmin());

      allow create: if isAuthenticated()
        && request.resource.data.senderId == request.auth.uid
        && isNonEmptyString(request.resource.data.content)
        && isNonEmptyString(request.resource.data.conversationId);

      // Only sender can update (e.g., edit message); admins can also update
      allow update: if isAuthenticated()
        && (resource.data.senderId == request.auth.uid || isAdmin());

      allow delete: if isAuthenticated()
        && (resource.data.senderId == request.auth.uid || isAdmin());
    }

    // ========================================================================
    // 5. Conversations
    //    - Only participants can read/write
    //    - Creator must be a participant
    //    - Admins can read all conversations
    // ========================================================================
    match /conversations/{conversationId} {
      allow read: if isAuthenticated()
        && (isParticipant(resource.data.participants) || isAdmin());

      allow create: if isAuthenticated()
        && request.auth.uid in request.resource.data.participants;

      allow update: if isAuthenticated()
        && isParticipant(resource.data.participants);

      allow delete: if isAdmin();
    }

    // ========================================================================
    // 6. Goals (Lane 1 - Re-Entry)
    //    - Users can CRUD their own goals
    //    - Case managers can read goals of assigned users
    //    - Admins can read all goals
    // ========================================================================
    match /goals/{goalId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAdmin()
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && isNonEmptyString(request.resource.data.title);

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        // Prevent changing ownership
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // 7. Journal Entries (Lane 2 - Step Experience)
    //    - Users can CRUD their own entries
    //    - Admins CANNOT read (privacy-first)
    //    - Exception: shared entries (isPrivate == false) visible to staff
    //    - Entries shared with specific users via sharedWith array
    // ========================================================================
    match /journal_entries/{entryId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            // Shared entries: visible to those in sharedWith array
            || (resource.data.isPrivate == false
                && request.auth.uid in resource.data.sharedWith)
            // Non-private entries visible to staff (but NOT private ones)
            || (resource.data.isPrivate == false && isStaff()));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && isNonEmptyString(request.resource.data.content);

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // 8. Wellness Check-ins / Daily Check-ins
    //    - Users own their data (create/read)
    //    - Case managers can read data of assigned users
    //    - Admins see aggregates via Cloud Functions only (no direct read)
    // ========================================================================
    match /wellness_checkins/{checkinId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Users cannot delete or update check-ins (immutable health data)
      allow update: if false;
      allow delete: if false;
    }

    match /daily_checkins/{checkinId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if false;
      allow delete: if false;
    }

    // ========================================================================
    // 9. User Progress (Lane 2 - Step Experience)
    //    - Users can read/write their own progress
    //    - Admins can read all progress
    //    - Staff can read for reporting
    // ========================================================================
    match /user_progress/{progressId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      allow delete: if false;
    }

    // ========================================================================
    // 10. Achievements
    //     - Users can read their own achievements
    //     - System (Cloud Functions with admin SDK) creates them
    //     - No client-side create/update/delete
    //     - Staff can read for dashboards
    // ========================================================================
    match /achievements/{achievementId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      // Only Cloud Functions (admin SDK) should create achievements
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    // ========================================================================
    // 11. Resumes (Lane 1 - Re-Entry / Employment)
    //     - Users own their resumes (full CRUD)
    //     - Case managers can read resumes of assigned users
    //     - Admins can read all
    // ========================================================================
    match /resumes/{resumeId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAdmin()
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // 12. Job Applications (Lane 1 - Re-Entry / Employment)
    //     - Users own their applications (full CRUD)
    //     - Staff can read for reporting
    // ========================================================================
    match /job_applications/{appId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ========================================================================
    // 13. Donations
    //     - Authenticated users can create donations
    //     - Only admins can read all donations
    //     - Donors can read their own donations
    // ========================================================================
    match /donations/{donationId} {
      allow read: if isAuthenticated()
        && (resource.data.donorId == request.auth.uid || isAdmin());

      allow create: if isAuthenticated();

      // Only admins can update donation records (e.g., mark refunded)
      allow update: if isAdmin();

      allow delete: if false;
    }

    // ========================================================================
    // 14. Resources (Lane 3 - My Struggle / Community)
    //     - All authenticated users can read
    //     - Admins can CRUD
    // ========================================================================
    match /resources/{resourceId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================================
    // 15. Events
    //     - All authenticated users can read
    //     - Admins can CRUD
    //     - Users can update RSVP fields only (via array union on attendees)
    // ========================================================================
    match /events/{eventId} {
      allow read: if isAuthenticated();

      allow create: if isAdmin();

      allow update: if isAdmin()
        // Allow any authenticated user to update RSVP (attendees array)
        || (isAuthenticated()
            && request.resource.data.diff(resource.data).affectedKeys()
               .hasOnly(['attendees', 'updatedAt']));

      allow delete: if isAdmin();
    }

    // ========================================================================
    // 16. Courses & Modules (Lane 2 - Step Experience)
    //     - All authenticated users can read
    //     - Admins can CRUD
    // ========================================================================
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /course_modules/{moduleId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Also support modules as a subcollection of courses
    match /courses/{courseId}/modules/{moduleId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================================
    // 17. Notifications
    //     - Users can read/update their own notifications (e.g., mark read)
    //     - Only system (Cloud Functions) or staff can create notifications
    // ========================================================================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated()
        && resource.data.userId == request.auth.uid;

      // Users can only update 'read' field on their own notifications
      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['read', 'updatedAt']);

      // Only staff/system can create notifications
      allow create: if isStaff();

      allow delete: if isAdmin();
    }

    // ========================================================================
    // 18. Reports (Admin only)
    //     - Only admins can read/write
    // ========================================================================
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================================
    // Additional Collections (from existing schema)
    // ========================================================================

    // -- Documents (Document Vault - Lane 1) --
    match /documents/{docId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAdmin()
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            // Staff can verify documents
            || isStaff());

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // -- Document Requests --
    match /documentRequests/{requestId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());
      allow create: if isStaff();
      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // -- Action Plans (Lane 1) --
    match /action_plans/{planId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow delete: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // -- Appointments --
    match /appointments/{appointmentId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // -- Budgets (Lane 1 - Financial) --
    match /budgets/{budgetId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid
            || isAdmin()
            || isAssignedCaseManager(resource.data.userId));

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated()
        && resource.data.userId == request.auth.uid
        && request.resource.data.userId == resource.data.userId;

      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // -- Mentor Matches (Lane 3) --
    match /mentor_matches/{matchId} {
      allow read: if isAuthenticated()
        && (resource.data.mentorId == request.auth.uid
            || resource.data.menteeId == request.auth.uid
            || isStaff());

      allow create: if isAuthenticated();

      allow update: if isAuthenticated()
        && (resource.data.mentorId == request.auth.uid
            || resource.data.menteeId == request.auth.uid
            || isStaff());

      allow delete: if isAdmin();
    }

    // -- Assessments --
    match /assessments/{assessmentId} {
      allow read: if isAuthenticated()
        && (resource.data.userId == request.auth.uid || isStaff());

      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid;

      // Assessments are immutable once submitted
      allow update: if false;
      allow delete: if false;
    }

    // -- Moderation Reports --
    match /moderationReports/{reportId} {
      allow read: if isStaff();

      allow create: if isAuthenticated()
        && request.resource.data.reportedBy == request.auth.uid;

      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // -- Moderation Queue --
    match /moderationQueue/{queueId} {
      allow read: if isStaff();
      allow create: if isStaff();
      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // -- App Settings (admin-managed, all can read) --
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================================================
    // Deny-all fallback
    // Any collection not explicitly matched above is denied by default.
    // ========================================================================
  }
}
