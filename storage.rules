rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ======================================================================
    // Helper Functions
    // ======================================================================

    /// Returns true if the request is from an authenticated user.
    function isAuthenticated() {
      return request.auth != null;
    }

    /// Returns true if the authenticated user's UID matches the given userId.
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /// Returns true if the user is an admin or super_admin.
    function isAdmin() {
      return isAuthenticated()
        && request.auth.token.role in ['admin', 'super_admin'];
    }

    /// Returns true if the user is admin, super_admin, or case_manager.
    function isStaff() {
      return isAdmin()
        || (isAuthenticated() && request.auth.token.role == 'case_manager');
    }

    /// Returns true if the file is an allowed image type.
    function isImage() {
      return request.resource.contentType in [
        'image/jpeg',
        'image/png',
        'image/webp'
      ];
    }

    /// Returns true if the file is an allowed document type.
    function isDocument() {
      return request.resource.contentType in [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'text/plain',
        'text/csv'
      ];
    }

    /// Returns true if file size is under the given limit in megabytes.
    function isUnderSizeMB(maxMB) {
      return request.resource.size < maxMB * 1024 * 1024;
    }

    /// Returns true if the file is an allowed video type.
    function isVideo() {
      return request.resource.contentType in [
        'video/mp4',
        'video/webm',
        'video/quicktime'
      ];
    }

    // ======================================================================
    // User Files: /users/{userId}/*
    // Users can upload to their own folder. Admins can read all.
    // ======================================================================

    // -- Profile Photos: /users/{userId}/profile/* --
    // Owner can read/write. All authenticated users can read (for avatars).
    // Max 10MB, images only (jpeg, png, webp).
    match /users/{userId}/profile/{fileName} {
      allow read: if isAuthenticated();

      allow write: if isOwner(userId)
        && isImage()
        && isUnderSizeMB(10);

      allow delete: if isOwner(userId) || isAdmin();
    }

    // -- User Documents: /users/{userId}/documents/* --
    // Owner can read/write. Staff can read (case managers, admins).
    // Max 50MB for documents (PDF, Word, Excel, text, CSV).
    match /users/{userId}/documents/{fileName} {
      allow read: if isOwner(userId) || isStaff();

      allow write: if isOwner(userId)
        && isDocument()
        && isUnderSizeMB(50);

      allow delete: if isOwner(userId) || isAdmin();
    }

    // -- General user uploads: /users/{userId}/* --
    // Catch-all for other user files (e.g., resume attachments).
    // Owner can read/write. Staff can read. 10MB images or 50MB documents.
    match /users/{userId}/{allPaths=**} {
      allow read: if isOwner(userId) || isStaff();

      allow write: if isOwner(userId)
        && (
          (isImage() && isUnderSizeMB(10))
          || (isDocument() && isUnderSizeMB(50))
        );

      allow delete: if isOwner(userId) || isAdmin();
    }

    // ======================================================================
    // Post Media: /posts/{postId}/*
    // Only the post author can upload. All authenticated can read.
    // Max 10MB for images, 50MB for videos.
    // ======================================================================
    match /posts/{postId}/{fileName} {
      allow read: if isAuthenticated();

      // The post author uploads media. We check that the uploader's UID
      // is stored in the custom metadata field 'authorId'.
      allow write: if isAuthenticated()
        && request.resource.metadata.authorId == request.auth.uid
        && (
          (isImage() && isUnderSizeMB(10))
          || (isVideo() && isUnderSizeMB(50))
        );

      allow delete: if isAuthenticated()
        && (resource.metadata.authorId == request.auth.uid || isAdmin());
    }

    // ======================================================================
    // Chat Media: /chat/{conversationId}/*
    // Authenticated users can read/write chat attachments.
    // Max 10MB for images, 50MB for documents.
    // ======================================================================
    match /chat/{conversationId}/{fileName} {
      allow read: if isAuthenticated();

      allow write: if isAuthenticated()
        && (
          (isImage() && isUnderSizeMB(10))
          || (isDocument() && isUnderSizeMB(50))
          || (isVideo() && isUnderSizeMB(50))
        );

      allow delete: if isAdmin();
    }

    // ======================================================================
    // Course Content: /courses/{courseId}/*
    // All authenticated users can read. Only admins can write.
    // ======================================================================
    match /courses/{courseId}/{allPaths=**} {
      allow read: if isAuthenticated();

      allow write: if isAdmin();

      allow delete: if isAdmin();
    }

    // ======================================================================
    // Resource Images: /resources/{resourceId}/*
    // All authenticated users can read. Only admins can write.
    // Max 10MB images only.
    // ======================================================================
    match /resources/{resourceId}/{fileName} {
      allow read: if isAuthenticated();

      allow write: if isAdmin()
        && isImage()
        && isUnderSizeMB(10);

      allow delete: if isAdmin();
    }

    // ======================================================================
    // Event Media: /events/{eventId}/*
    // All authenticated users can read. Only admins can write.
    // ======================================================================
    match /events/{eventId}/{allPaths=**} {
      allow read: if isAuthenticated();

      allow write: if isAdmin()
        && (isImage() || isDocument())
        && isUnderSizeMB(10);

      allow delete: if isAdmin();
    }

    // ======================================================================
    // Admin-only: /admin/*
    // Only admins can read/write (reports, exports, etc.).
    // ======================================================================
    match /admin/{allPaths=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
      allow delete: if isAdmin();
    }

    // ======================================================================
    // Deny-all fallback
    // Any path not matched above is denied by default.
    // ======================================================================
  }
}
